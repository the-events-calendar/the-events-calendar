name: "Reusable: Sync Translations"

on:
  workflow_call:
    inputs:
      target-branch:
        description: "Target branch for the workflow"
        required: false
        type: string
        default: "main"
      # Allow passing through any additional inputs for future extensibility
      additional-inputs:
        description: "Additional inputs to pass through (JSON string)"
        required: false
        type: string
        default: "{}"
    secrets:
      TRANSLATIONS_DEPLOY_HOST:
        required: true
      TRANSLATIONS_DEPLOY_USER:
        required: true
      TRANSLATIONS_DEPLOY_SSH_KEY:
        required: true
      TRANSLATIONS_DEPLOY_POT_LOCATION:
        required: true

jobs:
  sync-translations:
    name: 🔁 Sync Translations
    runs-on: ubuntu-latest
    outputs:
      translation-summary:
        description: "Summary of translation changes"
        value: ${{ steps.set-summary.outputs.summary }}
      changes-made:
        description: "Whether any changes were made"
        value: ${{ steps.vars.outputs.should_glotpress }}
    steps:
      - name: Setup environment
        uses: ./.github/workflows/reusable/basic-setup.yml
        with:
          setup-php: false
          setup-node: false
          fetch-depth: 1000

      - name: Set Variables
        id: vars
        run: |
          branch_name="${{ inputs.target-branch || github.head_ref || github.ref_name }}"
          should_glotpress=0
          if [[ "$branch_name" =~ ^release/.* || "$branch_name" == "master" || "$branch_name" == "main" ]]; then
              should_glotpress=1
          fi
          echo "should_glotpress=$should_glotpress" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT

      - name: Fetch Plugin Slug from .puprc
        id: puprc
        run: |
          plugin_slug=$(jq '.i18n | map(select(.url | contains("translations.stellarwp.com")) | .slug) | first' .puprc)
          echo "plugin_slug=$plugin_slug" >> $GITHUB_ENV
          echo "plugin_slug=$plugin_slug" >> $GITHUB_OUTPUT
          echo "## Plugin Slug: \`$plugin_slug\`" >> $GITHUB_STEP_SUMMARY

      - uses: the-events-calendar/actions/.github/actions/generate-pot@main
        id: generate-pot
        with:
          plugin_path: ${{ github.workspace }}
          pot_path: ${{github.workspace}}/lang/${{ steps.puprc.outputs.plugin_slug }}.pot

      - uses: the-events-calendar/actions/.github/actions/push-translations@main
        id: push-translations
        if: steps.vars.outputs.should_glotpress == '1'
        with:
          plugin_slug: ${{ steps.puprc.outputs.plugin_slug }}
          pot_path: lang/${{ steps.puprc.outputs.plugin_slug }}.pot
        env:
          TRANSLATIONS_DEPLOY_HOST: ${{ secrets.TRANSLATIONS_DEPLOY_HOST }}
          TRANSLATIONS_DEPLOY_USER: ${{ secrets.TRANSLATIONS_DEPLOY_USER }}
          TRANSLATIONS_DEPLOY_SSH_KEY: ${{ secrets.TRANSLATIONS_DEPLOY_SSH_KEY }}
          TRANSLATIONS_DEPLOY_POT_LOCATION: ${{ secrets.TRANSLATIONS_DEPLOY_POT_LOCATION }}

      - uses: the-events-calendar/actions/.github/actions/add-changelog@main
        id: add-changelog-entry
        if: steps.vars.outputs.should_glotpress == '1'
        with:
          file: "task-i18n-${{ steps.vars.outputs.sha_short }}"
          significance: patch
          type: language
          entry: "${{ steps.push-translations.outputs.glotpress-result }}"

      - name: Set output for translation summary
        id: set-summary
        run: |
          if [ "${{ steps.vars.outputs.should_glotpress }}" == "1" ]; then
            echo "summary=${{ steps.push-translations.outputs.glotpress-result }}" >> $GITHUB_OUTPUT
          else
            echo "summary=No translation sync performed (not a release branch)" >> $GITHUB_OUTPUT
          fi
