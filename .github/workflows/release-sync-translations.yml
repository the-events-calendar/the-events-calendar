name: "Release: Sync Translations"

on:
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
    inputs:
      target-branch:
        description: "Target branch for the workflow"
        required: false
        type: string
        default: "main"
  workflow_call:
    inputs:
      target-branch:
        description: "Target branch for the workflow"
        required: false
        type: string
        default: "main"
    secrets:
      TRANSLATIONS_DEPLOY_HOST:
        required: true
      TRANSLATIONS_DEPLOY_USER:
        required: true
      TRANSLATIONS_DEPLOY_SSH_KEY:
        required: true
      TRANSLATIONS_DEPLOY_POT_LOCATION:
        required: true
      GHA_BOT_TOKEN_MANAGER:
        required: true

jobs:
  sync-translations:
    name: 🔁 Sync Translations
    runs-on: ubuntu-latest
    outputs:
      translation-summary: ${{ steps.sync-translations.outputs.translation-summary }}
      changes-made: ${{ steps.sync-translations.outputs.changes-made }}
    steps:
      - name: Sync translations
        id: sync-translations
        uses: the-events-calendar/actions/.github/actions/sync-translations@main
        with:
          target-branch: ${{ inputs.target-branch || github.head_ref || github.ref_name }}
          translations-deploy-host: ${{ secrets.TRANSLATIONS_DEPLOY_HOST }}
          translations-deploy-user: ${{ secrets.TRANSLATIONS_DEPLOY_USER }}
          translations-deploy-ssh-key: ${{ secrets.TRANSLATIONS_DEPLOY_SSH_KEY }}
          translations-deploy-pot-location: ${{ secrets.TRANSLATIONS_DEPLOY_POT_LOCATION }}

      # Create PR only when run individually
      - name: Create Pull Request
        if: github.event_name == 'workflow_dispatch' && steps.sync-translations.outputs.changes-made == 'true'
        uses: peter-evans/create-pull-request@v7
        id: create-pull-request
        with:
          token: ${{ secrets.GHA_BOT_TOKEN_MANAGER }}
          base: ${{ inputs.target-branch || github.head_ref || github.ref_name }}
          branch: "task/i18n-update-${{ inputs.target-branch || github.head_ref || github.ref_name }}-with-${{ github.sha }}"
          title: "[BOT] Generate POT file for '${{ inputs.target-branch || github.head_ref || github.ref_name }}'"
          assignees: ${{ github.actor }}
          reviewers: the-events-calendar/engineers
          body: |
            This is an automated PR created by ${{ github.actor }}.
            It was generated by [this GitHub Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          labels: "automation"
          commit-message: |
            :symbols: Updating .pot file and add language changelog for ${{ github.sha }}

            This is an automated PR created by ${{ github.actor }}.
            Generated by: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Check outputs
        if: github.event_name == 'workflow_dispatch' && steps.sync-translations.outputs.changes-made == 'true' && steps.create-pull-request.outputs.pull-request-number
        run: |
          echo "## Pull Request"  >> $GITHUB_STEP_SUMMARY
          echo "* Number - ${{ steps.create-pull-request.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "* URL - [${{ steps.create-pull-request.outputs.pull-request-url }}](${{ steps.create-pull-request.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
