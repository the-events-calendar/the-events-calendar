let pastCurrentPage,upcomingCurrentPage,upgradeBoxElement=null,localizedData=null,ajaxUrl=null,pollInterval=5e3,pollTimeoutId=null,currentViewState={poll:!0};export const selectors={upgradeBox:"#tec-ct1-upgrade-dynamic",startPreviewButton:".tec-ct1-upgrade-start-migration-preview",startMigrationButton:".tec-ct1-upgrade-start-migration",cancelMigrationButton:".tec-ct1-upgrade-cancel-migration",revertMigrationButton:".tec-ct1-upgrade-revert-migration",paginateButton:"[data-events-paginate]"};export const buildQueryString=(e={})=>{if(!(e instanceof Object&&!Array.isArray(e)||"string"==typeof e))throw new Error("data must be an object or a string");if("string"==typeof e){const t={};e.split("&").map(e=>{const[n,r]=e.split("=",2);t[n]=r}),e=t}const t=Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&");return t?"?"+t:""};export const ajaxGet=(e,t={},n,r,a)=>{if(!e)return;const o=e+buildQueryString(t),i=new XMLHttpRequest;i.open("GET",o,!0),i.onreadystatechange=function(){if(i.readyState===XMLHttpRequest.DONE){const e=i.status;if(0===e||e>=200&&e<400)try{n&&n(JSON.parse(this.response))}catch(e){a&&a(this.response)}else r&&r(this.response)}},i.onerror=function(){a&&a()},i.send()};export const getUpgradeBoxElement=()=>document.getElementById(selectors.upgradeBox.substr(1));export const onSuccess=()=>{};export const onFailure=()=>{};export const onError=()=>{};export const recursePollForReport=()=>{syncReportData(pollForReport)};export const shouldPoll=()=>currentViewState.poll||tecCt1Upgrade.forcePolling;export const pollForReport=()=>{shouldPoll()&&(pollTimeoutId=setTimeout(recursePollForReport,pollInterval))};export const handleReportData=function(e){const{nodes:t,key:n,html:r}=e;currentViewState.key&&currentViewState.key===n||(getUpgradeBoxElement().innerHTML=r,bindNodes(n)),t.forEach(e=>{if(isNodeDiff(e.key,e.hash)){let t=document.querySelector(e.target);t&&(e.prepend?t.innerHTML=e.html+t.innerHTML:e.append?t.innerHTML=t.innerHTML+e.html:t.innerHTML=e.html,bindNodes(e.key))}}),currentViewState=e};export const bindNodes=e=>{let t;(t=document.querySelectorAll(selectors.startPreviewButton))&&t.forEach(function(e){e.removeEventListener("click",handleStartMigrationWithPreview),e.addEventListener("click",handleStartMigrationWithPreview)}),(t=document.querySelectorAll(selectors.startMigrationButton))&&t.forEach(function(e){e.removeEventListener("click",handleStartMigration),e.addEventListener("click",handleStartMigration)}),(t=document.querySelectorAll(selectors.cancelMigrationButton))&&t.forEach(function(e){e.removeEventListener("click",handleCancelMigration),e.addEventListener("click",handleCancelMigration)}),(t=document.querySelectorAll(selectors.revertMigrationButton))&&t.forEach(function(e){e.removeEventListener("click",handleRevertMigration),e.addEventListener("click",handleRevertMigration)}),(t=document.querySelectorAll(selectors.paginateButton))&&t.forEach(function(e){e.removeEventListener("click",handlePaginateClick(e)),e.addEventListener("click",handlePaginateClick(e))})};const handlePaginateClick=e=>t=>{t.preventDefault();const n=!!e.dataset.eventsPaginateUpcoming,r=e.dataset.eventsPaginateCategory,a=e.dataset.eventsPaginateStartPage;n?upcomingCurrentPage||(upcomingCurrentPage=a):pastCurrentPage||(pastCurrentPage=a);const o=n?upcomingCurrentPage++:pastCurrentPage++;ajaxGet(tecCt1Upgrade.ajaxUrl,{action:tecCt1Upgrade.actions.paginateEvents,page:o,upcoming:n?1:0,report_category:r,_ajax_nonce:tecCt1Upgrade.nonce},({html:e,append:n,prepend:a,has_more:o})=>{const i=document.querySelector(`.tec-ct1-upgrade-events-category-${r}`);if(i.innerHTML=a?e+i.innerHTML:n?i.innerHTML+e:e,!o){let e=document.querySelector(".tec-ct1-upgrade-migration-pagination-separator");e&&e.remove(),t.target.remove()}})};export const handleCancelMigration=e=>{e.preventDefault(),confirm(tecCt1Upgrade.text_dictionary.confirm_cancel_migration)&&(e.target.setAttribute("disabled","disabled"),e.target.removeEventListener("click",handleCancelMigration),undoMigration(tecCt1Upgrade.actions.cancelMigration))};export const handleRevertMigration=e=>{e.preventDefault(),confirm(tecCt1Upgrade.text_dictionary.confirm_revert_migration)&&(e.target.setAttribute("disabled","disabled"),e.target.removeEventListener("click",handleRevertMigration),undoMigration(tecCt1Upgrade.actions.revertMigration))};export const undoMigration=e=>{cancelReportPoll(),ajaxGet(tecCt1Upgrade.ajaxUrl,{action:e,_ajax_nonce:tecCt1Upgrade.nonce},e=>{handleReportData(e),pollForReport()})};export const handleStartMigrationWithPreview=e=>{e.preventDefault(),e.target.setAttribute("disabled","disabled"),e.target.removeEventListener("click",handleStartMigrationWithPreview),startMigration(!0)};export const handleStartMigration=e=>{e.preventDefault();const t=tecCt1Upgrade.text_dictionary.migration_in_progress_paragraph+" "+tecCt1Upgrade.text_dictionary.migration_prompt_plugin_state_addendum;confirm(t)&&(e.target.setAttribute("disabled","disabled"),e.target.removeEventListener("click",handleStartMigration),startMigration(!1))};export const startMigration=e=>{cancelReportPoll(),ajaxGet(tecCt1Upgrade.ajaxUrl,{action:tecCt1Upgrade.actions.startMigration,tec_events_custom_tables_v1_migration_dry_run:e?1:0,_ajax_nonce:tecCt1Upgrade.nonce},e=>{handleReportData(e),pollForReport()})};export const cancelReportPoll=()=>{clearTimeout(pollTimeoutId)};export const isNodeDiff=(e,t)=>{const{nodes:n}=currentViewState;if(!n)return!0;const r=n.find(({key:t})=>t===e);return!r||r.hash!==t};export const syncReportData=function(e=null){getReport(function(t){handleReportData(t),e&&e(t)})};export const getReport=e=>{var t={action:tecCt1Upgrade.actions.getReport,_ajax_nonce:tecCt1Upgrade.nonce};tecCt1Upgrade.isMaintenanceMode&&(t.is_maintenance_mode="1"),ajaxGet(tecCt1Upgrade.ajaxUrl,t,e)};export const init=()=>{(localizedData=window.tecCt1Upgrade)&&(upgradeBoxElement=getUpgradeBoxElement(),ajaxUrl=localizedData.ajaxUrl,0!==(pollInterval=localizedData.pollInterval||pollInterval)&&syncReportData(pollForReport))};"loading"!==document.readyState?init():document.addEventListener("DOMContentLoaded",init);